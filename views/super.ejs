<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="robots" content="noindex, nofollow">
  <title>Super Admin ‚Äî Valle Vista Commons</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script>
    (function(){try{var t=localStorage.getItem('vvc-theme'),s=localStorage.getItem('vvc-scheme');document.documentElement.setAttribute('data-scheme',s||'forest');document.documentElement.setAttribute('data-theme',t||(window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'));}catch(e){document.documentElement.setAttribute('data-scheme','forest');document.documentElement.setAttribute('data-theme','light');}})();
  </script>
</head>
<body>
  <div class="vvc-container" style="max-width: 700px;">
    <!-- Header -->
    <header class="admin-header">
      <div>
        <a href="/" class="admin-brand">
          <div class="admin-brand-mark">VV</div>
          <span class="admin-brand-text">Valle Vista Commons</span>
        </a>
        <span class="admin-breadcrumb">/ Super Admin</span>
      </div>
      <div class="admin-nav">
        <a href="/admin" class="nav-btn">Mod Panel</a>
        <a href="/" class="nav-btn">View Board</a>
        <div class="theme-menu">
          <button class="theme-trigger" aria-label="Appearance" title="Appearance">
            <svg viewBox="0 0 24 24"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>
          </button>
          <div class="theme-popover">
            <div class="popover-label">Mode</div>
            <div class="mode-toggle">
              <button class="mode-btn active" data-mode="light" title="Light">‚òÄÔ∏è</button>
              <button class="mode-btn" data-mode="dark" title="Dark">üåô</button>
            </div>
            <div class="popover-divider"></div>
            <div class="popover-label">Color</div>
            <div class="scheme-picker">
              <button class="scheme-dot active" data-scheme="forest" title="Forest"></button>
              <button class="scheme-dot" data-scheme="terracotta" title="Terracotta"></button>
              <button class="scheme-dot" data-scheme="slate" title="Slate"></button>
              <button class="scheme-dot" data-scheme="sage" title="Sage"></button>
              <button class="scheme-dot" data-scheme="indigo" title="Indigo"></button>
            </div>
            <div class="scheme-active-label">Forest</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Error/Success Messages -->
    <% if (error) { %>
      <div class="alert-banner danger">
        <span>‚úó</span>
        <% if (error === 'invalid_username') { %>Username must be 3-30 characters, lowercase letters/numbers/underscore only.
        <% } else if (error === 'password_short') { %>Password must be at least 8 characters.
        <% } else if (error === 'username_taken') { %>That username is already taken.
        <% } else if (error === 'mod_not_found') { %>Mod not found.
        <% } else if (error === 'invalid_model') { %>Invalid model selection.
        <% } else if (error === 'llm_failed') { %>LLM connection failed ‚Äî check API key and try again.
        <% } else { %><%= error %><% } %>
      </div>
    <% } %>
    <% if (msg) { %>
      <div class="alert-banner success">
        <span>‚úì</span>
        <% if (msg === 'mod_created') { %>Mod created successfully!
        <% } else if (msg === 'llm_saved') { %>LLM settings saved.
        <% } else if (msg === 'llm_ok') { %>LLM connection test passed!
        <% } else if (msg === 'site_saved') { %>Site settings saved.
        <% } else { %>Done.<% } %>
      </div>
    <% } %>

    <!-- ‚ïê‚ïê‚ïê MOD MANAGEMENT ‚ïê‚ïê‚ïê -->
    <div class="admin-section">
      <div class="admin-section-header">
        <span class="admin-section-title">Moderator Management</span>
      </div>

      <div class="panel-card">
        <% if (mods.length === 0) { %>
          <p style="text-align: center; padding: 0.75rem 0; color: var(--text-muted); font-size: 0.85rem;">No moderators yet. Create one below.</p>
        <% } else { %>
          <% mods.forEach(mod => { %>
            <div class="mod-row">
              <div style="flex: 1;">
                <strong style="font-size: 0.9rem; color: var(--text-primary);"><%= mod.username %></strong>
                <span class="<%= mod.active ? 'status-active' : 'status-disabled' %>" style="margin-left: 8px;"><%= mod.active ? 'Active' : 'Disabled' %></span>
                <div style="font-size: 0.72rem; color: var(--text-muted); margin-top: 4px;">
                  Created <%= new Date(mod.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %>
                  <% if (modRewriteStats && modRewriteStats[mod.id]) { %>
                    ¬∑ <span style="color: var(--accent-primary);"><%=modRewriteStats[mod.id].total || 0 %> rewrites</span>
                    (<%=modRewriteStats[mod.id].lastHour || 0 %> in last hour)
                  <% } %>
                </div>
                <div style="font-size: 0.72rem; color: var(--text-muted); margin-top: 2px;">
                  Rewrite: <span style="color: <%= mod.rewriteEnabled ? 'var(--accent-success)' : 'var(--accent-warning)' %>;"><%= mod.rewriteEnabled ? 'Enabled' : 'Disabled' %></span>
                  ¬∑ Limits: <%= mod.rewriteLimitPerPost %>/post, <%= mod.rewriteLimitPerHour %>/hour
                </div>
              </div>
              <div style="display: flex; gap: 6px; flex-direction: column; align-items: flex-end;">
                <div style="display: flex; gap: 6px;">
                  <form method="POST" action="/super/mods/<%= mod.id %>/toggle" style="display:inline;">
                    <button type="submit" class="action-btn outline <%= mod.active ? '' : 'success' %>" style="<%= mod.active ? 'border-color: var(--accent-warning-soft); color: var(--accent-warning);' : '' %>">
                      <%= mod.active ? 'Disable' : 'Enable' %>
                    </button>
                  </form>
                  <button type="button" class="action-btn outline" onclick="toggleModRewriteForm('<%= mod.id %>')">
                    ‚öôÔ∏è Rewrite
                  </button>
                  <form method="POST" action="/super/mods/<%= mod.id %>/delete" style="display:inline;"
                        onsubmit="return confirm('Delete mod &quot;<%= mod.username %>&quot; permanently?')">
                    <button type="submit" class="action-btn outline delete">Delete</button>
                  </form>
                </div>
                <div id="modRewriteForm-<%= mod.id %>" style="display: none; margin-top: 8px; padding: 12px; background: var(--bg-lighter); border-radius: 8px; width: 300px;">
                  <form method="POST" action="/super/mods/<%= mod.id %>/rewrite-settings">
                    <div style="margin-bottom: 8px;">
                      <label style="font-size: 0.75rem; color: var(--text-secondary); display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" name="rewriteEnabled" <%= mod.rewriteEnabled ? 'checked' : '' %> style="width: auto;">
                        Enable AI Rewrite
                      </label>
                    </div>
                    <div style="margin-bottom: 8px;">
                      <label style="font-size: 0.75rem; color: var(--text-secondary);">Per-Post Limit</label>
                      <input type="number" name="rewriteLimitPerPost" value="<%= mod.rewriteLimitPerPost %>" min="1" max="50" class="vvc-input" style="font-size: 0.85rem; padding: 6px 10px;">
                    </div>
                    <div style="margin-bottom: 8px;">
                      <label style="font-size: 0.75rem; color: var(--text-secondary);">Per-Hour Limit</label>
                      <input type="number" name="rewriteLimitPerHour" value="<%= mod.rewriteLimitPerHour %>" min="1" max="100" class="vvc-input" style="font-size: 0.85rem; padding: 6px 10px;">
                    </div>
                    <div style="display: flex; gap: 6px;">
                      <button type="submit" class="action-btn outline success" style="flex: 1; font-size: 0.8rem;">Save</button>
                      <button type="button" class="action-btn outline" style="flex: 1; font-size: 0.8rem;" onclick="toggleModRewriteForm('<%= mod.id %>')">Cancel</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>

      <!-- Create Mod Form -->
      <div class="panel-card">
        <h6 style="font-weight: 700; font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.75rem;">Create New Mod</h6>
        <form method="POST" action="/super/mods/create" style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
          <div>
            <label class="vvc-label" style="font-size: 0.75rem;">Username</label>
            <input type="text" name="username" class="vvc-input" placeholder="lowercase, 3-30 chars" required pattern="[a-z0-9_]{3,30}" style="font-size: 0.85rem; padding: 8px 12px; width: auto;">
          </div>
          <div>
            <label class="vvc-label" style="font-size: 0.75rem;">Password</label>
            <input type="password" name="password" class="vvc-input" placeholder="8+ characters" required minlength="8" style="font-size: 0.85rem; padding: 8px 12px; width: auto;">
          </div>
          <button type="submit" class="panel-btn-primary">Create Mod</button>
        </form>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê LLM CONFIGURATION ‚ïê‚ïê‚ïê -->
    <div class="admin-section">
      <div class="admin-section-header">
        <span class="admin-section-title">LLM Configuration</span>
      </div>

      <% if (!hasApiKey) { %>
        <div class="alert-banner warning">
          <span>‚ö†</span> <strong>No API key set.</strong> Add <code>OPENROUTER_API_KEY</code> to enable AI features.
        </div>
      <% } %>

      <div class="panel-card">
        <form method="POST" action="/super/settings/llm">
          <div class="row mb-3">
            <div class="col-md-6 mb-2">
              <label class="vvc-label" style="font-size: 0.8rem;">Analysis Model</label>
              <select name="analysisModel" class="vvc-select" style="font-size: 0.85rem; padding: 8px 12px;">
                <% models.forEach(m => { %>
                  <option value="<%= m.id %>" <%= settings && settings.analysisModel === m.id ? 'selected' : '' %>>
                    <%= m.name %> <% if (m.note) { %>(<%- m.note %>)<% } %>
                  </option>
                <% }) %>
              </select>
              <p class="model-note">Used for auto-analyzing submitted tips</p>
            </div>
            <div class="col-md-6 mb-2">
              <label class="vvc-label" style="font-size: 0.8rem;">Rewrite Model</label>
              <select name="rewriteModel" class="vvc-select" style="font-size: 0.85rem; padding: 8px 12px;">
                <% models.forEach(m => { %>
                  <option value="<%= m.id %>" <%= settings && settings.rewriteModel === m.id ? 'selected' : '' %>>
                    <%= m.name %> <% if (m.note) { %>(<%- m.note %>)<% } %>
                  </option>
                <% }) %>
              </select>
              <p class="model-note">Used for on-demand tip rewrites</p>
            </div>

            <div class="field-group">
              <label class="model-label">In-Editor Rewrite Prompt</label>
              <textarea name="rewritePrompt" class="vvc-textarea" rows="6" placeholder="Custom prompt template for AI Rewrite button in editor (leave blank for default)"
                        style="font-size: 0.85rem; padding: 8px 12px; font-family: monospace;"><%= settings && settings.rewritePrompt ? settings.rewritePrompt : '' %></textarea>
              <p class="model-note">Leave blank for default: "Rewrite this text to be clear, concise, and factual. Fix grammar and spelling. Maintain the original meaning."</p>
            </div>
          </div>
          <button type="submit" class="panel-btn-primary">Save LLM Settings</button>
        </form>

        <hr style="border-color: var(--surface-border); margin: 1rem 0;">

        <form method="POST" action="/super/settings/llm-test" style="display: flex; align-items: center; gap: 10px;">
          <button type="submit" class="action-btn outline" <%= !hasApiKey ? 'disabled' : '' %>>Test LLM Connection</button>
          <span style="font-size: 0.75rem; color: var(--text-muted);">Sends a simple test prompt to the analysis model</span>
        </form>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SITE SETTINGS ‚ïê‚ïê‚ïê -->
    <div class="admin-section">
      <div class="admin-section-header">
        <span class="admin-section-title">Site Settings</span>
      </div>

      <div class="panel-card">
        <form method="POST" action="/super/settings/site">
          <div class="field-group">
            <label class="vvc-label" style="font-size: 0.8rem;">Board Name</label>
            <input type="text" name="boardName" class="vvc-input" value="<%= settings ? settings.boardName : 'Valle Vista Commons' %>" maxlength="100" style="font-size: 0.85rem; padding: 8px 12px;">
          </div>
          <div class="field-group">
            <label class="vvc-label" style="font-size: 0.8rem;">Tagline</label>
            <input type="text" name="boardTagline" class="vvc-input" value="<%= settings ? settings.boardTagline : 'Your neighborhood board' %>" maxlength="200" style="font-size: 0.85rem; padding: 8px 12px;">
          </div>
          <div class="field-group">
            <label class="vvc-label" style="font-size: 0.8rem;">About Text</label>
            <textarea name="aboutText" class="vvc-textarea" rows="4" maxlength="2000" placeholder="Shown at the bottom of the public board" style="font-size: 0.85rem;"><%= settings ? settings.aboutText || '' : '' %></textarea>
          </div>
          <button type="submit" class="panel-btn-primary">Save Site Settings</button>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/theme.js"></script>
  <script src="/js/lightbox.js"></script>
  <script>
    function toggleModRewriteForm(modId) {
      const form = document.getElementById('modRewriteForm-' + modId);
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }
  </script>
  <script>if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js');}</script>
</body>
</html>
