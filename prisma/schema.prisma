generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id          String    @id @default(cuid())
  title       String    @db.VarChar(100)
  desc        String    @db.Text
  location    String?   @db.VarChar(100)
  latitude    Float?
  longitude   Float?
  locationName String?  @db.VarChar(200)
  section     Section   @default(NEIGHBORS)
  status      Status    @default(PENDING)
  pinned      Boolean   @default(false)
  urgent      Boolean   @default(false)
  modNote     String?   @db.Text
  modPost     Boolean   @default(false)
  eventDate   DateTime?
  expiresAt   DateTime?
  editedAt    DateTime?
  createdAt   DateTime  @default(now()) @map("created_at")
  approvedAt  DateTime? @map("approved_at")
  aiAnalysis  Json?
  descHistory Json?     // Array of {title, desc, timestamp} â€” last 10 versions for undo
  rewriteCount Int      @default(0) // How many times this post has been rewritten (for 10 per post limit)
  submitterId Int?      @map("submitter_id")
  submitter   Submitter? @relation(fields: [submitterId], references: [id])
  rewriteLogs RewriteLog[]

  @@map("posts")
}

model Submitter {
  id          Int       @id @default(autoincrement())
  hash        String    @unique @db.VarChar(64)
  blocked     Boolean   @default(false)
  blockAction String?   @db.VarChar(10)   // "REJECT" or "FLAG"
  blockedAt   DateTime? @map("blocked_at")
  blockedBy   String?   @db.VarChar(50)   // mod username who blocked
  blockReason String?   @db.VarChar(200)  @map("block_reason")
  createdAt   DateTime  @default(now())   @map("created_at")
  posts       Post[]

  @@map("submitters")
}

model Mod {
  id        String   @id @default(cuid())
  username  String   @unique @db.VarChar(50)
  passHash  String   @db.VarChar(64)
  active    Boolean  @default(true)
  rewriteEnabled Boolean @default(true) // Can this mod use AI rewrite?
  rewriteLimitPerPost Int @default(10) // Max rewrites per post
  rewriteLimitPerHour Int @default(5)  // Max rewrites per hour
  createdAt DateTime @default(now()) @map("created_at")
  rewriteLogs RewriteLog[]

  @@map("mods")
}

model SiteSettings {
  id                   String   @id @default("default")
  boardName            String   @default("Valle Vista Commons")
  boardTagline         String   @default("Your neighborhood board")
  analysisModel        String   @default("anthropic/claude-3.5-haiku")
  rewriteModel         String   @default("anthropic/claude-3.5-haiku")
  customAnalysisModel  String?  @db.VarChar(100)
  customRewriteModel   String?  @db.VarChar(100)
  rewritePrompt        String?  @db.Text // Custom prompt template for in-editor AI rewrite
  aboutText            String?  @db.Text
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}

model RewriteLog {
  id        String   @id @default(cuid())
  postId    String   @map("post_id")
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  modId     String   @map("mod_id")
  mod       Mod      @relation(fields: [modId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([postId])
  @@index([modId])
  @@index([createdAt])
  @@map("rewrite_logs")
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String   @db.VarChar(50)   // "approve", "reject", "block", "edit", etc.
  postId    String?  @map("post_id")
  targetId  String?  @map("target_id") // submitter ID for block actions, mod ID for mod actions
  modUser   String   @db.VarChar(50)   // username of mod who performed action
  details   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([modUser])
  @@map("audit_logs")
}

enum Section {
  ALERT
  HAPPENINGS
  LOST_FOUND
  NEIGHBORS
  BOARD_NOTES
}

enum Status {
  PENDING
  LIVE
  EXPIRED
  REJECTED
  DELETED
}
